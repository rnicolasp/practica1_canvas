<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="contextPath" th:content="@{/}">
    <title>ePaint - Canvas</title>
    <link rel="stylesheet" th:href="@{/css/home.css}">
</head>
<body class="canvas-editor-body">
<div class="card">

    <div class="canvas-top-bar">
        <div class="nav-group">
            <a th:href="@{/home}"><button>Inicio</button></a>
            <a th:href="@{/profile}"><button>Mi Perfil</button></a>
        </div>

        <div class="tool-group">
            <span id="autosaveStatus" class="small-muted" style="margin: 0 8px; transition: opacity 0.5s;"></span>
            <button id="undoBtn" disabled title="Deshacer" style="padding: 6px 8px;">Deshacer</button>
            <button id="redoBtn" disabled title="Rehacer" style="padding: 6px 8px;">Rehacer</button>
            <button id="saveBtn" th:if="${canEdit}">Guardar</button>
            <button id="settingsToggle">Ajustes</button>
            <button id="shareBtn" th:if="${isOwner}">Compartir</button>
            <button id="historyBtn" th:if="${loadId != null}">Historial</button>
        </div>
    </div>

    <div id="sizePanel">
        <label style="margin-right:8px">Ancho: <input id="inputWidth" type="number" min="100" max="2000" th:value="${width}" style="width:80px"></label>
        <label style="margin-right:8px">Alto: <input id="inputHeight" type="number" min="100" max="2000" th:value="${height}" style="width:80px"></label>
        <button id="applySize">Aplicar</button>
        <button id="resetSize" type="button">Restablecer</button>
        <label>Privacidad:
            <select id="privacy">
                <option value="0" th:selected="${privacyValue == '0'}">Privado</option>
                <option value="1" th:selected="${privacyValue == '1'}">Publico</option>
            </select>
        </label>
    </div>

    <div id="sharePanel" class="popup-panel">
        <h3>Compartir Lienzo</h3>
        <div class="popup-row">
            <input type="text" id="shareUser" placeholder="Usuario..." style="flex:1;">
            <select id="sharePerm">
                <option value="READ">Leer</option>
                <option value="WRITE">Editar</option>
            </select>
            <button id="doShareBtn" class="btn-primary">+</button>
        </div>
        <ul id="shareList" class="popup-list"></ul>
        <button onclick="document.getElementById('sharePanel').style.display='none'" class="popup-close-btn">Cerrar</button>
    </div>

    <div id="historyPanel" class="popup-panel">
        <h3>Historial de Versiones</h3>
        <p class="small-muted">Haz clic en una versión para cargarla.</p>
        <ul id="historyList" class="popup-list"></ul>
        <button onclick="document.getElementById('historyPanel').style.display='none'" class="popup-close-btn">Cerrar</button>
    </div>

    <div class="canvas-area">
        <div style="flex:1">
            <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <h3 class="canvas-title" style="margin:0; cursor:pointer;" title="Doble click para editar"
                        ondblclick="this.style.display='none';document.getElementById('canvasNameInput').style.display='block';document.getElementById('canvasNameInput').focus();"
                        id="canvasNameDisplay"
                        th:text="${canvasName ?: 'Lienzo sin título'}">Lienzo sin título</h3>

                    <input type="text" id="canvasNameInput"
                           th:value="${canvasName ?: 'Lienzo sin título'}"
                           style="display:none; font-size:1.17em; margin:0; padding:4px;"
                           onblur="this.style.display='none';document.getElementById('canvasNameDisplay').style.display='block';document.getElementById('canvasNameDisplay').textContent=this.value;"
                           onkeypress="if(event.keyCode===13)this.blur();">
                </div>
                <div class="canvas-wrap">
                    <canvas id="paintCanvas"
                            th:width="${width}"
                            th:height="${height}"
                            th:data-initial-width="${width}"
                            th:data-initial-height="${height}"
                            th:data-load-id="${loadId}"
                            style="background:#fff;display:block;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="floating-toolbox" class="sidebar">
    <div class="toolbox-header">Herramientas</div>
    <div class="card">
        <div class="form-column">
            <label>Modo:
                <select id="mode">
                    <option value="libre">Dibujo a mano alzada</option>
                    <option value="shape">Añadir forma (arrastrar)</option>
                    <option value="select">Seleccionar / Mover</option>
                </select>
            </label>
            <label>Forma:
                <select id="shapeType">
                    <option value="circulo">Círculo</option>
                    <option value="cuadrado">Cuadrado</option>
                    <option value="triangulo">Triángulo</option>
                    <option value="estrella">Estrella 7 puntas</option>
                </select>
            </label>
            <label>Color: <input id="color" type="color" value="#ff0000"></label>
            <label>Tamaño (px):
                <input id="size" type="range" min="1" max="100" value="8">
                <span id="sizeDisplay" class="small-muted">8</span>
            </label>
            <div class="controls-row" style="display:flex; gap:5px; margin-top:10px;">
                <button id="addCenter" style="flex:1;">Centro</button>
                <button id="clearAll" style="flex:1;">Limpiar</button>
            </div>
        </div>
        <hr>
        <h3 class="center">Objetos</h3>
        <ul id="objects" class="object-list"></ul>
    </div>
</div>

<script th:if="${canvasData}" th:inline="javascript">
    /*<![CDATA[*/
    window.INITIAL_CANVAS_DATA = [(${canvasData})];
    /*]]>*/
</script>
<script th:src="@{/js/canvas.js}"></script>
</body>
</html>